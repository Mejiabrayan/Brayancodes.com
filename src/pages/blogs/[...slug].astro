---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '~/layouts/Layout.astro';
import Container from '~/components/container.astro';
import { Image } from 'astro:assets';
import { ViewTransitions } from 'astro:transitions';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blogs', ({ id }: any) => {
    return id.endsWith('.md') || id.endsWith('.mdx');
  });

  return blogPosts.map((blog: any) => ({
    params: { slug: blog.slug },
    props: { blog },
  }));
}

interface Props {
  blog: CollectionEntry<'blogs'>;
}

const { blog } = Astro.props;
const { Content } = await blog.render();
const { title, description, date, image } = blog.data;
---

<Layout title={`${title} | Brayan M. Cuenca Blog`}>
  <ViewTransitions />
  <Container>
    <article class='max-w-sm md:max-w-3xl lg:max-4xl mx-auto'>
      <!-- Header -->
      <header class='text-center space-y-4 mb-12'>
        <h1 class='text-4xl font-[Tobias] italic text-neutral-300'>{title}</h1>
        <p class='text-lg text-neutral-300/90'>{description}</p>
        <div class="flex items-center justify-center gap-4 text-sm text-neutral-300/70 font-mono">
          <time>
            {
              new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })
            }
          </time>
          <span class="text-neutral-300/40">â€¢</span>
          <span id="viewCount" class="flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
            <span>--</span>
          </span>
        </div>
      </header>

      {
        image && (
          <div class='reflection-wrapper'>
            <div class='relative isolate aspect-video w-full rounded-lg overflow-hidden'>
              <Image
                src={image}
                alt={title}
                width={1000}
                height={1000}
                class='w-full h-full object-cover'
                loading='lazy'
              />
            </div>

            <!-- Reflection -->
            <div class='relative isolate aspect-video w-full overflow-hidden reflection'>
              <Image
                src={image}
                alt={`${title} reflection`}
                width={1000}
                height={1000}
                class='w-full h-[75%] object-cover'
                loading='lazy'
              />
            </div>
          </div>
        )
      }

      <!-- Content -->
      <div
        class='prose prose-neutral prose-invert max-w-none leading-normal mt-12
        prose-headings:font-[Tobias] prose-headings:italic
        prose-h1:text-neutral-300 prose-h1:text-2xl 
        prose-h2:text-neutral-300 prose-h2:text-xl
        prose-h3:text-neutral-300 prose-h3:text-lg
        prose-h4:text-neutral-300 prose-h4:text-base
        prose-p:text-neutral-300
        prose-a:text-white prose-a:no-underline hover:prose-a:text-neutral-200
        prose-strong:text-white
        prose-li:text-neutral-300
        prose-code:rounded-sm prose-code:border prose-code:border-white/10
        prose-code:bg-transparent prose-code:text-neutral-300 prose-code:px-1
        prose-ul:text-neutral-300'
      >
        <Content />
      </div>
    </article>
  </Container>
</Layout>

<script define:vars={{ slug: blog.slug }}>
  // Fetch view count on page load
  fetch(`/api/${slug}`)
    .then((res) => res.json())
    .then((data) => {
      if (data.views) {
        const viewCount = document.getElementById('viewCount')?.lastElementChild;
        if (viewCount) {
          viewCount.textContent = `${data.views.toLocaleString()} views`;
        }
      }
    })
    .catch((err) => console.error('Failed to fetch views:', err));
</script>

<style>
  .reflection-wrapper {
    position: relative;
    padding-bottom: 15px;
  }

  .reflection {
    transform: rotateX(180deg) translateY(20%);
    mask-image: linear-gradient(transparent 40%, white 90%);
    -webkit-mask-image: linear-gradient(transparent 40%, white 90%);
    opacity: 0.5;
    filter: blur(1.5px) brightness(1.5);
  }
</style>
